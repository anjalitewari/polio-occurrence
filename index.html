<html>
  <head>
    <title>Polio Occurences Around the World : 1980 - 2016</title>
    <link rel="stylesheet" type="text/css" href="leaflet/leaflet.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="js/script.js"></script>
    <script type="text/javascript" src="leaflet/leaflet.js"></script>
    <script src="leaflet/leaflet-src.js"></script>

    <!-- <script src="leaflet/leaflet.timeline.js"></script> -->

    <style>
      @import url(http://fonts.googleapis.com/css?family=Open+Sans); 
      html, body{
        margin: 0;
        padding: 0;
        font-family: "Open Sans", sans-serif;
      }
      #info{
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 20vw;
        padding: 1em;
      }
      #map{
        position: fixed;
        top: 0;
        left: 20vw;
        bottom: 0;
        right: 0;
      }
      .leaflet-bottom.leaflet-left{
        width: 100%;
      }
      .leaflet-control-container .leaflet-timeline-controls{
        box-sizing: border-box;
        width: 100%;
        margin: 0;
        margin-bottom: 15px;
      }
    </style>
  </head>

  <body>
    <div id="info" style="overflow: auto">
      <h1>Polio</h1>
      <h2>1980 - 2016</h2>
      <h3>Currently displayed:</h3>
      <div id="cbcountries"></div>
    </div>
	<div id="map"></div>

	<script>
    var map;
    var ajaxRequest;
    var plotlist;
    var plotlayers=[];
    
    // define map
    var osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.tileLayer(osmUrl, {
        maxZoom: 18,
        attribution: osmAttrib,
        noWrap: true
     });

    var map = new L.map('map', {
      layers: [osm],
      center: new L.LatLng(0,0),
      zoom: 2,
      maxBounds: [[90,-180], [-90, 180]]
    });

    // get data
    $.getJSON('poliodata.geojson')
    .done(function(data) {
      var info = processData(data);
      createPropSymbols(info.timestamps, data, info.currcountries);
      //createLegend(info.min, info.max);
      createSliderUI(info.timestamps);
    })
    .fail(function() { alert('There has been a problem loading the data.')});

    // process years and countries from data
    function processData(data) {
      var timestamps = [];
      var min = Infinity; 
      var max = -Infinity;
      var occ = 0;
      var countries = [];
      var currcountries = [];

      for (var feature in data.features)  {

        var properties = data.features[feature].properties; 
        for (var attribute in properties) { 

          if ( attribute != "FIELD1" &&
          attribute != "FIELD2") {

            if ( $.inArray(timestamps,attribute) === -1) {
              timestamps.push(attribute);   
            }

            if (properties[attribute] < min) {  
              min = properties[attribute];
            }

            if (properties[attribute] > max) { 
              max = properties[attribute]; 
            }
          }
          else {
            if(attribute == "FIELD2") {
              countries.push(properties[attribute]);
            }
          }
        }

      }
      return {
        timestamps : timestamps,
        min : min,
        max : max,
        countries : countries,
        currcountries : currcountries
      }
    }

    // add circlemarkers to map
    function createPropSymbols(timestamps, data, currcountries=[]) {
      cities = L.geoJson(data, {    
        pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, {
              fillColor: '#708598',
              color: '#537898',
              weight: 1, 
              fillOpacity: 0.6 
            }).on({
              mouseover: function(e) {
                this.openPopup();
                this.setStyle({color: 'yellow'});
              },
              mouseout: function(e) {
                this.closePopup();
                this.setStyle({color: '#537898'});
              }
            });
        }
      }).addTo(map);

      updatePropSymbols(timestamps[0], data, currcountries);
      // update country list on side panel
      //updateCountriestoPanel(timestamps[0]);
    }

    // add popups and remove markers from countries with no occurrences
    function updatePropSymbols(timestamp, data, currcountries=[]) {
      console.log(currcountries);
      cities.eachLayer(function(layer) {
        var props = layer.feature.properties;
        var radius = calcPropRadius(props[timestamp]);
        // add/remove the 0 occurrences props from map
        // add/remove countries that have more than one occurrences to side panel
        if(props[timestamp] == 0) {
          layer.removeFrom(map);
          var curr = props['FIELD2'];
          // for(var i = 0; i < currcountries.length; i++) {
          //   if(curr.localeCompare(currcountries[i]) == 0) {
          //                   console.log('remove');

          //     array.splice(array.indexOf(i),1);
          //     
          //   }
          // }
        }
        if(props[timestamp] > 0) {
          layer.addTo(map);
          currcountries.push(props['FIELD2']);
          //updateCountrytoPanel(timestamp, props['FIELD2'], layer, 'a');
        }
        var popupContent = '<b>' + String(props[timestamp]) + 
           ' occurrences</b><br>' +
           'in </i>' + props['FIELD2'] + ' in ' +
            timestamp + '</i>';
        layer.setRadius(radius);
        layer.bindPopup(popupContent, { offset: new L.Point(0,-radius) });
      });
      //updateCountriestoPanel(timestamp, currcountries, layer);
    }

    //returns prop radius depending on number of occurrences
    function calcPropRadius(attributeValue) {
      var scaleFactor = 5;
      var area = attributeValue * scaleFactor;
      return Math.sqrt(area/Math.PI);     
    }

//ADDS ALL COUNTRIES TO SIDE PANEL
  // function updateCountriestoPanel(timestamp) {
  //   cities.eachLayer(function(layer) {
  //     var props = layer.feature.properties;
  //     if(props[timestamp] > 0) {
  //       var checkbox = document.createElement('input');

  //       checkbox.type = "checkbox";
  //       checkbox.name = props["FIELD2"];
  //       checkbox.value = props[timestamp];
  //       checkbox.id = "cbid";
  //       checkbox.checked =true;

  //       var label = document.createElement('cblabel')
  //       label.htmlFor = "cbid";
  //       label.appendChild(document.createTextNode(props["FIELD2"]));
  //       cbcountries.appendChild(checkbox);
  //       cbcountries.appendChild(label);
  //       cbcountries.appendChild(document.createElement("br"));
  //     }
  //   });
  //}

  //when country checkbox changes
  $('#cbid').change(function(){
    if(this.checked) {
      console.log('checked');
      cities.eachLayer(function(layer) {
        layer.addTo(map);
      });
    }
    else {
      console.log('unchecked');
      cities.eachLayer(function(layer) {
        layer.removeFrom(map);  
      });
    }
});

  function createSliderUI(timestamps) {
    var sliderControl = L.control({ position: 'bottomleft'} );
    sliderControl.onAdd = function(map) {
      var slider = L.DomUtil.create('input', 'range-slider');
      L.DomEvent.addListener(slider, 'mousedown', function(e) { 
        L.DomEvent.stopPropagation(e); 
      });

      $(slider)
      .attr({'type':'range', 
        'max': timestamps[timestamps.length-1], 
        'min': timestamps[0], 
        'step': 1})
        .on('input change', function() {
        updatePropSymbols($(this).val().toString());
      });
      return slider;
    }
    sliderControl.addTo(map);
    createTemporalLegend(timestamps[0], timestamps[timestamps.length-1]);
  }

  function createTemporalLegend(startTimestamp, endTimestamp) {
    var temporalLegend = L.control({ position: 'bottomleft' }); 
    temporalLegend.onAdd = function(map) { 
      var output = L.DomUtil.create('output', 'temporal-legend');
      $(output).text(startTimestamp);
      return output; 
    }
    temporalLegend.addTo(map); 
  }


    //map legend
  // function createLegend(min, max) {
  //   if (min < 10) { 
  //     min = 10; 
  //   }

  //   function roundNumber(inNumber) {
  //     return (Math.round(inNumber/10) * 10);  
  //   }

  //   var legend = L.control( { position: 'bottomright' } );

  //   legend.onAdd = function(map) {

  //     var legendContainer = L.DomUtil.create('div', 'legend');  
  //     var symbolsContainer = L.DomUtil.create('div', 'symbolsContainer');
  //     var classes = [roundNumber(min), roundNumber((max-min)/2), roundNumber(max)]; 
  //     var legendCircle;  
  //     var lastRadius = 0;
  //     var currentRadius;
  //     var margin;

  //     L.DomEvent.addListener(legendContainer, 'mousedown', function(e) { 
  //       L.DomEvent.stopPropagation(e); 
  //     });  

  //   $(legendContainer).append('<h2 id="legendTitle"># of occurrences</h2>');
    
  //   for (var i = 0; i <= classes.length-1; i++) {  

  //     legendCircle = L.DomUtil.create('div', 'legendCircle');  
      
  //     currentRadius = calcPropRadius(classes[i]);
      
  //     margin = -currentRadius - lastRadius - 2;

  //     $(legendCircle).attr('style', 'width: ' + currentRadius*2 + 
  //       'px; height: ' + currentRadius*2 + 
  //       'px; margin-left: ' + margin + 'px' );        
  //     $(legendCircle).append('<span class="legendValue">'+classes[i]+'</span>');

  //     $(symbolsContainer).append(legendCircle);

  //     lastRadius = currentRadius;
  //   }

  //   $(legendContainer).append(symbolsContainer); 
  //   return legendContainer; 
  //   };
  //   legend.addTo(map);
  //   console.log("added!");
  // }
</script>
</body>
</html>